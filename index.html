<!DOCTYPE html>
<html>
    <head>
    <title>Photo Contact</title>
    <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
    <link rel="stylesheet" href="jquery.mobile-1.0.1.min.css" />
    <script src="jquery-1.7.1.min.js"></script> 
    <script src="jquery.mobile-1.0.1.min.js"></script>
    <script src="jquery.validate-1.9.0.min.js"></script>
    <style>
			.photoPreview {
				width: 220px;
				height: 220px;
				margin: 10px auto;
				border: 1px solid #999;
				border-radius: 10px;
				position: relative;
			}
			#photoButton {
				width: inherit;
				height: inherit;
				line-height: 200px;
				text-align: center;
				font-size: 24px;
				font-weight: bold;
				cursor: pointer;
			}
			#photoPreview {
				width: 200px;
				height: 200px;
				margin: 9px;
				border: 1px solid #999;
				display: none;
			}
			.ui-field-contain > label:first-child {
				width: 4em;
				display: inline-block;
			}
			/* Form Error Classes */
			input.error {
				background-color: #FCC;
				color: #C00;
			}
			label.error {
				display: block;
				position: absolute;
				bottom: -12px;
				left: 70px;
				z-index: 99999;
				max-width: 200px;
				font-size: 11px;
				color: #c00;
			}
			#contactListWrapper, #contactListEmpty {
				display: none;
			}
		</style>
    <script type="text/javascript" charset="utf-8">
		$(function() {
        // Init
				var db = window.openDatabase("contacts", "1.0", "Contacts DB", 1000000);
				db.transaction(populateDB, onFail);
			
			/*
			 * New Contact Page Functions
			 */
			
			$('#photoButton').click(function() {
				//alert('Take Photo');
				// Take picture using device camera, allow edit, and retrieve image as base64-encoded string  
				navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 75, allowEdit: true, 
						destinationType : Camera.DestinationType.FILE_URI, 
						sourceType : Camera.PictureSourceType.CAMERA, 
						encodingType: Camera.EncodingType.JPEG,
						targetWidth: 200,
						targetHeight: 200 }); 
			});
			
			//$("#nameBox").tipTip({activation:"focus",defaultPosition:"top",content:"test Name"});
			//$("#emailBox").tipTip({activation:"focus",defaultPosition:"top",content:"test Email"});
			
			$('#contactForm').validate({
				rules: {
					contactName: {required:true},
					contactEmail: {required:true,email:true},
					contactPhone: {required:true,digits:true}
				},
   			submitHandler: function() { onSave() }
			});
			
			var onPhotoURISuccess = function(imageURI) {
				// Uncomment to view the image file URI 
				console.log(imageURI);
				// Get image handle
				$("#photoPreview").attr("src", imageURI).show();
				$("#photoButton").hide();
			}
			
			// Save Contact to DB
			var onSave = function() {
        // Init
				var db = window.openDatabase("contacts", "1.0", "Contacts DB", 1000000);
				db.transaction(function(tx) {
					tx.executeSql('INSERT INTO contact (contactName, contactEmail, contactPhone, contactPhoto) VALUES (?,?,?,?)', [
						$('#nameBox').val(),
						$('#emailBox').val(),
						$('#phoneBox').val(),
						$('#photoBox').val()
						], {}, onFail);
				}, onFail, onSuccess);
			}
			
			var validateContact = function() {
				
			}
			
			/*
			 * Manage Contact Page Functions
			 */
			
			// Read DB
			$('#manageContact').on('pageshow', function(e, ui) {
				db.transaction(readDB, onFail);
			});
				
			$('#manageContact').on('pagebeforehide', function(e, ui) {
				$('#contactListEmpty').hide();
				$('#contactListWrapper').hide();
			});
			 
			var readDB = function(tx) {
        tx.executeSql('SELECT * FROM contact', [], listContact, onFail);
			}
			
			// List Contact List
			var listContact = function(tx, results) {
				var list = $('#contactList');
				var anchorObj;
  			list.html("");
				
				var len = results.rows.length;
				var result;
				console.log("Result Rows = " + len);
				if (len > 0) {
					$('#contactListEmpty').hide();
					$('#contactListWrapper').show();
					for (var i=0; i<len; i++){
						result = results.rows.item(i);
						// Create List Item Anchor Obj
						anchorObj = $('<a />', {name: '#'}).append(
							$('<img />', {
								src: 'icons/Icon512.png'
							})).append(
							$('<h1 />', {
								html: result.contactName
							})).append(
							$('<p />', {
								html: result.contactEmail
							})).append(
							$('<p />', {
								html: result.contactPhone
							}));
						
						// Create List Item
						list.append(
							$('<li />', {id: 'C'+result.id}).append(anchorObj).append(
		
								/** BEGIN - Remove Contact Split Button **/
								$('<a />', {
									href: '#C'+result.id,
									class: 'delete'
								}).on('click', {}, function(e) {
									var cid = $(this).attr('href').substring(2)
									var confirmDelete = confirm("Delete contact CID: " + cid + "?");
									if (confirmDelete) {
										console.log('Delete CID: '+cid);
										db.transaction(function(tx) {
											tx.executeSql('SELECT * FROM contact WHERE id=?', [cid], function(tx, results)
											{
												var len = results.rows.length;
												if (len > 0) {
													var photoPath = results.rows.item(0).contactPhoto;
													tx.executeSql('DELETE FROM contact WHERE id=?', [cid], function(tx, results)
													{
														$('#C'+cid).remove();
														list.listview('refresh');
														// Delete also the picture - photoPath
														console.log("Delete Photo: " + photoPath);
													}, onFail);
												}
											}, onFail);
										}, onFail);
									}
								})
								/** END - Remove Contact Split Button **/
							)
						);
					}
					list.listview('refresh');
				} else {
					$('#contactListEmpty').show();
					$('#contactListWrapper').hide();
				}
			}
			
			// Delete Contact
			var deleteContact = function(e) {
				
			}
			
			// Clear Contacts
			var clearContacts = function() {
				
			}
			
			$('#clearContact').on('click', function(e) {
				db.transaction(function(tx){
					tx.executeSql('DROP TABLE IF EXISTS contact');
					tx.executeSql('CREATE TABLE IF NOT EXISTS contact (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, contactName TEXT, contactEmail TEXT, contactPhone TEXT, contactPhoto TEXT)');
				}, onFail, onClearSuccess);
			});
			
			var onClearSuccess = function(tx, results) {
				$('#contactList').html("");
				$('#contactListEmpty').show();
				$('#contactListWrapper').hide();
			}
			
			// Upload Contact
			var uploadContact = function() {
				
			}
			
			// Wait for PhoneGap to connect with the device
			document.addEventListener("deviceready",onDeviceReady,false);

		});

    // PhoneGap is ready to be used!
    function onDeviceReady() {
        // Init
				var db = window.openDatabase("contacts", "1.0", "Contacts DB", 1000000);
				db.transaction(populateDB, onFail);
    }
		
		function populateDB(tx) {
			//tx.executeSql('DROP TABLE IF EXISTS contact');
			tx.executeSql('CREATE TABLE IF NOT EXISTS contact (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, contactName TEXT, contactEmail TEXT, contactPhone TEXT, contactPhoto TEXT)');
			//tx.executeSql('INSERT INTO contact (contactName, contactEmail, contactPhone, contactPhoto) VALUES ("Name 1", "Email 1", "Phone 1", "Photo 1")', [], querySuccess, onFail);
			//tx.executeSql('INSERT INTO contact (contactName, contactEmail, contactPhone, contactPhoto) VALUES ("Name 2", "Email 2", "Phone 2", "Photo 2")', [], querySuccess, onFail);
		}

    // Transaction success callback
    //
    function successCB() {
        var db = window.openDatabase("contacts", "1.0", "Contacts DB", 1000000);
        db.transaction(queryDB, onFail);
    }

    // Query the database
    //
    function queryDB(tx) {
        tx.executeSql('SELECT * FROM contact', [], querySuccess, onFail);
    }

    // Query the success callback
    //
    function querySuccess(tx, results) {
			var len = results.rows.length;
			// this will be empty since no rows were inserted.
			//console.log("Insert ID = " + results.insertId);
			// this will be 0 since it is a select statement
			//console.log("Rows Affected = " + results.rowAffected);
			// the number of rows returned by the select statement
			console.log("Result Rows = " + len);
			if (len > 0) {
        for (var i=0; i<len; i++){
            console.log("Row = " + i + " ID = " + results.rows.item(i).id + " contactName =  " + results.rows.item(i).contactName);
        }
			}
    }

    // Called if Command successfull executed
    //
    //function onSuccess(someObject) {
    //  console.log(someObject);
    //}
		function onSuccess() {
    	alert("success!");
		}

    // Called if something bad happens.
    // 
    function onFail(message) {
      alert('Failed because: ' + message);
    }

    </script>
    </head>
    <body>
      <div data-role="page" id="home">
        <div data-role="header">
          <h1>Photo Contact</h1>
        </div>
        <div data-role="content">
          <p style="text-align:center;">Simple mobile app to take photo and record simple user contact info</p>
          <p><a href="#newContact" data-role="button" data-icon="plus">New Contact</a></p>
          <p><a href="#manageContact" data-role="button" data-icon="grid">Manage Contact</a></p>
        </div>
      </div>
      <div data-role="page" data-add-back-btn="true" id="newContact">
        <div data-role="header" data-position="fixed">
          <h1>New Contact</h1>
      	</div>
        <div data-role="content">
          <div class="ui-body ui-body-b">
          	<form id="contactForm" action="" method="post">
            <input name="contactPhoto" id="photoBox" type="hidden" value="randomPhotoPath" />
            <div class="photoPreview"><img id="photoPreview" src="" /><div id="photoButton">Take a Photo</div></div>
            <div id="nameDiv" data-role="fieldcontain">
            	<label for="contactName">Name*</label> <input type="text" name="contactName" id="nameBox" value="" />
            </div>
            <div id="emailDiv" data-role="fieldcontain">
            	<label for="contactEmail">Email*</label> <input type="text" name="contactEmail" id="emailBox" value="" />
            </div>
            <div id="phoneDiv" data-role="fieldcontain">
            	<label for="contactPhone">Phone*</label> <input type="text" name="contactPhone" id="phoneBox" maxlength="8" value="" />
            </div>
            <button type="submit" id="saveButton">Save Contact</button>
            </form>
          </div>
        </div>
      </div>
      <div data-role="page" data-add-back-btn="true" id="manageContact">
        <div data-role="header">
          <h1>Manage Contact</h1>
					<a id="clearContact" href="#" data-icon="delete" class="ui-btn-right">Clear All Contacts</a>
        </div>
        <div data-role="content">
	        <p id="contactListEmpty" style="text-align:center;">The contact list is empty</p>
          <div id="contactListWrapper">
          	<ul id="contactList" data-role="listview" data-inset="true" data-split-icon="delete" data-filter="true"></ul>
          </div>
        </div>
      </div>
		</body>
</html>